<div class="modal fade admin-modal modal-olive" id="modalDetallesReceta" tabindex="-1" aria-labelledby="modalDetallesRecetaLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">

            <!-- Header -->
            <div class="modal-header">
                <h5 class="modal-title" id="modalDetallesRecetaLabel">
                    <div class="modal-icon">
                        <i class="fas fa-book-open"></i>
                    </div>
                    Detalles de la Receta
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <!-- Body -->
            <div class="modal-body">

                <!-- Nombre + Categoría y Porciones como meta -->
                <div class="modal-entity-header entity-block">
                    <h5 id="detalles-nombre-receta" class="modal-entity-name"></h5>
                    <div class="modal-entity-meta">
                        <div class="modal-entity-meta-item">
                            <small>Categoría:</small>
                            <p id="detalles-categoria-receta"></p>
                        </div>
                        <div class="modal-entity-meta-item">
                            <small>Porciones:</small>
                            <p id="detalles-porciones-receta"></p>
                        </div>
                    </div>
                </div>

                <!-- Disponibilidad, Margen -->
                <div class="modal-data-grid-2">
                    <div class="modal-data-cell" style="grid-column: span 2;">
                        <label class="modal-data-label">
                            <i class="fas fa-toggle-on"></i> Disponibilidad
                        </label>
                        <span id="detalles-disponibilidad-badge-receta"
                              class="badge"
                              style="font-size:1rem;padding:0.6rem 1.5rem;border-radius:50px;display:inline-flex;align-items:center;gap:0.5rem;font-weight:600;"></span>
                    </div>
                    <div class="modal-data-cell">
                        <label class="modal-data-label">
                            <i class="fas fa-percent"></i> Margen
                        </label>
                        <p id="detalles-margen-receta" class="modal-data-value"></p>
                    </div>
                </div>

                <!-- Análisis Financiero -->
                <h6 class="modal-subsection-title">
                    <i class="fas fa-chart-line"></i> Análisis Financiero
                </h6>
                <div class="modal-summary">
                    <div class="modal-summary-grid">
                        <div>
                            <label class="modal-summary-label">
                                <i class="fas fa-coins"></i> Costo Total
                            </label>
                            <p id="detalles-costo-receta" class="modal-summary-value"></p>
                        </div>
                        <div>
                            <label class="modal-summary-label">
                                <i class="fas fa-tag"></i> Precio de Venta
                            </label>
                            <p id="detalles-precio-receta" class="modal-summary-value"></p>
                        </div>
                        <div>
                            <label class="modal-summary-label">
                                <i class="fas fa-coins"></i> Ganancia Neta
                            </label>
                            <p id="detalles-ganancia-receta" class="modal-summary-value summary-extra"></p>
                        </div>
                        <div>
                            <label class="modal-summary-label">
                                <i class="fas fa-percent"></i> Progreso del Margen
                            </label>
                            <div style="background: var(--cream-dark); height: 10px; border-radius: 5px; overflow: hidden; margin-top: 0.6rem;">
                                <div id="barra-margen" style="height: 100%; width: 0%; transition: width 0.5s ease; border-radius: 5px;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Ingredientes -->
                <h6 class="modal-subsection-title">
                    <i class="fas fa-shopping-basket"></i> Ingredientes
                </h6>
                <div class="modal-summary">
                    <div id="ingredientes-loader" style="text-align: center; padding: 2rem; display: none;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--olive-green);"></i>
                        <p style="margin-top: 1rem; color: var(--charcoal);">Cargando ingredientes...</p>
                    </div>
                    <div id="lista-ingredientes" style="max-height: 350px; overflow-y: auto;">
                        <!-- Los ingredientes se cargarán dinámicamente aquí -->
                    </div>
                </div>

            </div>

            <!-- Footer -->
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <span><i class="fas fa-times"></i> Cerrar</span>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const botonesDetalles = document.querySelectorAll('.btn-detalles-receta');

        botonesDetalles.forEach(boton => {
            boton.addEventListener('click', function () {
                const id           = parseInt(this.getAttribute('data-id'));
                const nombre       = this.getAttribute('data-nombre');
                const categoria    = this.getAttribute('data-categoria');
                const porciones    = this.getAttribute('data-porciones');
                const costo        = this.getAttribute('data-costo');
                const precio       = this.getAttribute('data-precio');
                const ganancia     = this.getAttribute('data-ganancia');
                const margen       = parseFloat(this.getAttribute('data-margen'));
                const disponibilidad = this.getAttribute('data-disponibilidad');

                document.getElementById('detalles-nombre-receta').textContent    = nombre;
                document.getElementById('detalles-categoria-receta').textContent = categoria;
                document.getElementById('detalles-porciones-receta').textContent = porciones + ' porciones';
                document.getElementById('detalles-margen-receta').textContent    = margen.toFixed(2) + '%';

                document.getElementById('detalles-costo-receta').textContent =
                    '₡' + parseFloat(costo).toLocaleString('es-CR', { minimumFractionDigits: 2 });
                document.getElementById('detalles-precio-receta').textContent =
                    '₡' + parseFloat(precio).toLocaleString('es-CR', { minimumFractionDigits: 2 });
                document.getElementById('detalles-ganancia-receta').textContent =
                    '₡' + parseFloat(ganancia).toLocaleString('es-CR', { minimumFractionDigits: 2 });

                // Badge de disponibilidad
                const dispBadge = document.getElementById('detalles-disponibilidad-badge-receta');
                if (disponibilidad === 'Disponible') {
                    dispBadge.innerHTML = '<i class="fas fa-check-circle"></i> Disponible';
                    dispBadge.style.background = 'var(--green)';
                } else {
                    dispBadge.innerHTML = '<i class="fas fa-times-circle"></i> No disponible';
                    dispBadge.style.background = 'var(--red)';
                }
                dispBadge.style.color = 'white';

                // Barra de margen con variables CSS
                const barraMargen = document.getElementById('barra-margen');
                barraMargen.style.width = Math.min(margen, 100) + '%';
                if (margen >= 50) {
                    barraMargen.style.background = 'linear-gradient(90deg, var(--green), #34ce57)';
                } else if (margen >= 30) {
                    barraMargen.style.background = 'linear-gradient(90deg, var(--yellow), #ffca2c)';
                } else {
                    barraMargen.style.background = 'linear-gradient(90deg, var(--red), #e4606d)';
                }

                cargarIngredientes(id);
            });
        });

        function cargarIngredientes(idReceta) {
            const listaIngredientes = document.getElementById('lista-ingredientes');
            const loader = document.getElementById('ingredientes-loader');

            loader.style.display = 'block';
            listaIngredientes.innerHTML = '';

            fetch(`/Receta/ObtenerIngredientes/${idReceta}`)
                .then(response => {
                    if (!response.ok) throw new Error('Error al cargar ingredientes');
                    return response.json();
                })
                .then(ingredientes => {
                    loader.style.display = 'none';

                    if (!ingredientes || ingredientes.length === 0) {
                        listaIngredientes.innerHTML =
                            '<p style="text-align:center;color:var(--charcoal);opacity:0.7;padding:2rem;">No hay ingredientes registrados</p>';
                        return;
                    }

                    ingredientes.forEach(ing => {
                        const div = document.createElement('div');
                        div.className = 'modal-data-cell';
                        div.style.cssText = 'display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem;';
                        div.innerHTML = `
                            <div>
                                <p class="modal-data-value" style="margin:0;">${ing.nombreInsumo}</p>
                                <small style="color:var(--charcoal);opacity:0.7;">
                                    ${ing.cantidadUtilizada.toLocaleString('es-CR', { minimumFractionDigits: 2 })} ${ing.unidadMedida}
                                </small>
                            </div>
                            <p class="modal-summary-value" style="margin:0;white-space:nowrap;">
                                ₡${ing.costoTotalIngrediente.toLocaleString('es-CR', { minimumFractionDigits: 2 })}
                            </p>
                        `;
                        listaIngredientes.appendChild(div);
                    });
                })
                .catch(error => {
                    loader.style.display = 'none';
                    console.error('Error:', error);
                    listaIngredientes.innerHTML =
                        '<p style="text-align:center;color:var(--red);padding:2rem;"><i class="fas fa-exclamation-triangle"></i><br/>Error al cargar ingredientes</p>';
                });
        }
    });
</script>