@model AromasWeb.Abstracciones.ModeloUI.HistorialTarifa

@{
    ViewBag.Title = "Registrar Nueva Tarifa";
}

<!-- Hero Section -->
<section class="hero" style="min-height: 40vh; padding: 8rem 0 4rem;">
    <div class="hero-bg-overlay"></div>
    <div class="hero-leaves"></div>
    <div class="container hero-container" style="display: block;">
        <div class="hero-content" data-aos="fade-up" style="text-align: center;">
            <span class="hero-badge">
                <i class="fas fa-plus-circle"></i>
                Nueva Tarifa
            </span>
            <h1 class="hero-title" style="font-size: 3.5rem;">
                Registrar
                <span class="hero-title-accent">Tarifa por Hora</span>
            </h1>
            <p class="hero-subtitle">
                Establece una nueva tarifa para un empleado con fecha de vigencia
            </p>
        </div>
    </div>
    <div class="scroll-indicator">
        <div class="mouse"><div class="wheel"></div></div>
    </div>
</section>

<!-- Formulario Section -->
<section class="admin-form-section">
    <div class="container" style="max-width: 80%;">
        @using (Html.BeginForm("CrearTarifa", "HistorialTarifa", FormMethod.Post))
        {
            @Html.AntiForgeryToken()
            @Html.HiddenFor(model => model.FechaRegistro)

            <div class="admin-form-wrapper" data-aos="fade-up">
                @Html.ValidationSummary(true, "Por favor, corrige los siguientes errores:", new { @class = "alert alert-danger" })

                @if (TempData["Error"] != null)
                {
                    <div style="background: rgba(231, 76, 60, 0.1); border-left: 4px solid var(--red); padding: 1.5rem; border-radius: 10px; margin-bottom: 2rem;">
                        <p style="margin: 0; color: #c0392b; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span>@TempData["Error"]</span>
                        </p>
                    </div>
                }

                <!-- Sección Empleado -->
                <div class="admin-form-header">
                    <i class="fas fa-user-tie"></i>
                    <h5>Información del Empleado</h5>
                </div>

                <div class="form-group">
                    <label>
                        <i class="fas fa-user"></i>
                        Seleccionar Empleado
                    </label>
                    @Html.DropDownListFor(model => model.IdEmpleado,
                    new SelectList(ViewBag.Empleados, "IdEmpleado", "NombreCompleto"),
                                "-- Selecciona un empleado --",
                                new { @class = "form-control", id = "selectEmpleado" })
                @Html.ValidationMessageFor(model => model.IdEmpleado, "", new { @class = "text-danger" })
            </div>

            <!-- Info del empleado seleccionado -->
            <div id="infoEmpleado" style="display: none; margin: 0 0 1.5rem; padding: 1.5rem; background: var(--cream); border-radius: 20px; border-left: 5px solid var(--olive-green);">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1.5rem;">
                    <div>
                        <small style="color: var(--charcoal); opacity: 0.7; font-size: 0.8rem; font-weight: 600; text-transform: uppercase; display: block; margin-bottom: 0.3rem;">
                            <i class="fas fa-briefcase" style="color: var(--olive-green);"></i> Cargo
                        </small>
                        <strong id="empleadoCargo" style="color: var(--dark-green);"></strong>
                    </div>
                    <div>
                        <small style="color: var(--charcoal); opacity: 0.7; font-size: 0.8rem; font-weight: 600; text-transform: uppercase; display: block; margin-bottom: 0.3rem;">
                            <i class="fas fa-id-card" style="color: var(--olive-green);"></i> Identificación
                        </small>
                        <strong id="empleadoIdentificacion" style="color: var(--dark-green);"></strong>
                    </div>
                    <div>
                        <small style="color: var(--charcoal); opacity: 0.7; font-size: 0.8rem; font-weight: 600; text-transform: uppercase; display: block; margin-bottom: 0.3rem;">
                            <i class="fas fa-coins-sign" style="color: var(--gold-bright);"></i> Tarifa Vigente
                        </small>
                        <strong id="empleadoTarifaActual" style="color: var(--gold-bright); font-size: 1.1rem;"></strong>
                    </div>
                </div>
            </div>

            <!-- Alerta salario mínimo -->
            <div class="admin-form-info-box" style="margin-bottom: 1.5rem;">
                <i class="fas fa-info-circle"></i>
                <div>
                    <strong>Salario Mínimo Legal 2025</strong>
                    <p>La tarifa por hora debe ser <strong>mayor o igual a ₡1,768.98</strong> (₡367,640 mensuales ÷ 207.84 horas).</p>
                </div>
            </div>

            <!-- Tarifa por Hora -->
            <div class="form-group">
                <label>
                    <i class="fas fa-coins-sign"></i>
                    Tarifa por Hora
                </label>
                @Html.EditorFor(model => model.TarifaHora, new { htmlAttributes = new { @class = "form-control", type = "number", step = "0.01", min = "0.01", placeholder = "0.00", id = "inputTarifa" } })
                @Html.ValidationMessageFor(model => model.TarifaHora, "", new { @class = "text-danger" })

                <!-- Cálculo en tiempo real -->
                <div id="calculoSalario" class="feature-card" style="margin-top: 1rem; padding: 1.5rem; display: none;">
                    <h6 style="color: var(--dark-green); margin-bottom: 1rem; font-weight: 600;">
                        <i class="fas fa-calculator"></i> Cálculo Estimado
                    </h6>
                    <div style="display: grid; gap: 0.7rem;">
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: var(--charcoal); opacity: 0.7;">Tarifa por hora:</span>
                            <strong id="tarifaHoraCalc" style="color: var(--dark-green);">₡0.00</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: var(--charcoal); opacity: 0.7;">Horas mensuales (48h/sem × 4.33):</span>
                            <strong style="color: var(--dark-green);">207.84 horas</strong>
                        </div>
                        <div style="border-top: 2px solid var(--cream); padding-top: 0.7rem; margin-top: 0.3rem; display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-size: 1.05rem; color: var(--dark-green); font-weight: 600;">Salario Mensual Estimado:</span>
                            <strong id="salarioMensualCalc" style="font-size: 1.3rem; color: var(--gold); font-family: var(--font-primary);">₡0.00</strong>
                        </div>
                    </div>
                    <div id="alertaSalarioMinimo" style="display: none; background: rgba(231, 76, 60, 0.1); border-left: 4px solid var(--red); padding: 1rem; border-radius: 10px; margin-top: 1rem;">
                        <p style="margin: 0; color: #c0392b; font-weight: 600; display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem;">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span>Esta tarifa es menor al salario mínimo legal (₡1,768.98/hora)</span>
                        </p>
                    </div>
                </div>
            </div>

            <!-- Fechas de Vigencia -->
            <div class="form-row">
                <div class="form-group">
                    <label>
                        <i class="fas fa-calendar-check"></i>
                        Fecha de Inicio de Vigencia
                    </label>
                    @Html.EditorFor(model => model.FechaInicio, new { htmlAttributes = new { @class = "form-control", type = "date" } })
                    @Html.ValidationMessageFor(model => model.FechaInicio, "", new { @class = "text-danger" })
                    <small class="admin-form-hint">
                        <i class="fas fa-info-circle"></i>
                        Fecha desde la cual esta tarifa será válida
                    </small>
                </div>

                <div class="form-group">
                    <label>
                        <i class="fas fa-calendar-times"></i>
                        Fecha de Fin de Vigencia (Opcional)
                    </label>
                    @Html.EditorFor(model => model.FechaFin, new { htmlAttributes = new { @class = "form-control", type = "date" } })
                    @Html.ValidationMessageFor(model => model.FechaFin, "", new { @class = "text-danger" })
                    <small class="admin-form-hint">
                        <i class="fas fa-info-circle"></i>
                        Dejar vacío si la tarifa no tiene fecha de finalización
                    </small>
                </div>
            </div>

            <!-- Motivo -->
            <div class="form-group">
                <label>
                    <i class="fas fa-comment"></i>
                    Motivo del Cambio de Tarifa
                </label>
                @Html.TextAreaFor(model => model.Motivo, new { @class = "form-control", rows = "4", placeholder = "Ej: Aumento por desempeño excepcional, Ajuste salarial anual, Cambio de cargo, etc." })
                @Html.ValidationMessageFor(model => model.Motivo, "", new { @class = "text-danger" })
            </div>

            <!-- Nota informativa -->
            <div class="admin-form-info-box">
                <i class="fas fa-info-circle"></i>
                <div>
                    <strong>Vigencia Automática</strong>
                    <p>Si existe una tarifa vigente para este empleado, se finalizará automáticamente al registrar esta nueva tarifa.</p>
                </div>
            </div>

            <!-- Botones -->
            <div class="admin-form-footer">
                <button type="button" class="btn btn-secondary" onclick="window.location.href='@Url.Action("ListadoTarifas", "HistorialTarifa")'">
                    <span><i class="fas fa-times"></i> Cancelar</span>
                </button>
                <button type="submit" id="btnGuardar" class="btn btn-primary btn-3d">
                    <span><i class="fas fa-save"></i> Registrar Tarifa</span>
                </button>
            </div>
        </div>
                }
    </div>
</section>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="~/js/historialTarifa.js"></script>
    <script>
        const HORAS_MENSUALES = 207.84;
        const TARIFA_MINIMA_LEGAL = 367640 / HORAS_MENSUALES; // ~1,768.98

        const inputTarifa     = document.getElementById('inputTarifa');
        const calculoSalario  = document.getElementById('calculoSalario');
        const tarifaHoraCalc  = document.getElementById('tarifaHoraCalc');
        const salarioMensualCalc = document.getElementById('salarioMensualCalc');
        const alertaMinimo    = document.getElementById('alertaSalarioMinimo');
        const btnGuardar      = document.getElementById('btnGuardar');
        const selectEmpleado  = document.getElementById('selectEmpleado');
        const infoEmpleado    = document.getElementById('infoEmpleado');

        // Cálculo en tiempo real
        inputTarifa.addEventListener('input', function () {
            const tarifa = parseFloat(this.value) || 0;
            if (tarifa > 0) {
                calculoSalario.style.display = 'block';
                tarifaHoraCalc.textContent = '₡' + tarifa.toLocaleString('es-CR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                salarioMensualCalc.textContent = '₡' + (tarifa * HORAS_MENSUALES).toLocaleString('es-CR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                alertaMinimo.style.display = tarifa < TARIFA_MINIMA_LEGAL ? 'block' : 'none';
            } else {
                calculoSalario.style.display = 'none';
            }
        });

        // Info del empleado al seleccionar
        selectEmpleado.addEventListener('change', function () {
            const opt = this.options[this.selectedIndex];
            if (!this.value) { infoEmpleado.style.display = 'none'; return; }
            document.getElementById('empleadoCargo').textContent          = opt.dataset.cargo || '—';
            document.getElementById('empleadoIdentificacion').textContent = opt.dataset.identificacion || '—';
            document.getElementById('empleadoTarifaActual').textContent   = opt.dataset.tarifaActual ? '₡' + parseFloat(opt.dataset.tarifaActual).toLocaleString('es-CR', { minimumFractionDigits: 2 }) : 'Sin tarifa vigente';
            infoEmpleado.style.display = 'block';
        });

        // Disparar si ya hay valores al cargar (edición / validación fallida)
        if (inputTarifa.value)   inputTarifa.dispatchEvent(new Event('input'));
        if (selectEmpleado.value) selectEmpleado.dispatchEvent(new Event('change'));
    </script>
}