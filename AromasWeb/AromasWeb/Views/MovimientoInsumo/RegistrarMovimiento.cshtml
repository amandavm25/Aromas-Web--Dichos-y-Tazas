@model AromasWeb.Abstracciones.ModeloUI.MovimientoInsumo

@{
    ViewBag.Title = "Registrar Movimiento";
    var insumo = ViewBag.Insumo as AromasWeb.Abstracciones.ModeloUI.Insumo;
    var todosInsumos = ViewBag.TodosInsumos as List<AromasWeb.Abstracciones.ModeloUI.Insumo>
                       ?? new List<AromasWeb.Abstracciones.ModeloUI.Insumo>();
    var esSalida = (bool)(ViewBag.EsSalida ?? false);
}

<!-- Hero Section -->
<section class="hero" style="min-height: 40vh; padding: 8rem 0 4rem;">
    <div class="hero-bg-overlay"></div>
    <div class="hero-leaves"></div>
    <div class="container hero-container" style="display: block;">
        <div class="hero-content" data-aos="fade-up" style="text-align: center;">
            <span class="hero-badge">
                <i class="fas fa-exchange-alt"></i>
                Gestión de Stock
            </span>
            <h1 class="hero-title" style="font-size: 3.5rem;">
                Registrar
                <span class="hero-title-accent">Movimiento</span>
            </h1>
            <p class="hero-subtitle">
                Registra entradas y salidas de insumos del inventario
            </p>
        </div>
    </div>
    <div class="scroll-indicator">
        <div class="mouse">
            <div class="wheel"></div>
        </div>
    </div>
</section>

<!-- Formulario Section -->
<section class="admin-form-section">
    <div class="container" style="max-width: 80%;">
        @using (Html.BeginForm("RegistrarMovimiento", "MovimientoInsumo", FormMethod.Post))
        {
            @Html.AntiForgeryToken()

            <!-- Hidden que se actualiza con JS según el combobox -->
            <input type="hidden" name="IdInsumo" id="hiddenIdInsumo" value="@Model?.IdInsumo" />

            <div class="admin-form-wrapper" data-aos="fade-up">
                @Html.ValidationSummary(true, "Por favor, corrige los siguientes errores:", new { @class = "alert alert-danger" })

                <!-- Encabezado -->
                <div class="admin-form-header">
                    <i class="fas fa-exchange-alt"></i>
                    <h5>Información del Movimiento</h5>
                </div>

                <div class="admin-form-body">

                    <!-- Combobox de insumo (siempre visible) -->
                    <div class="form-group">
                        <label>
                            <i class="fas fa-box"></i>
                            Insumo
                        </label>
                        <select id="selectorInsumo" class="form-control" required>
                            <option value="">-- Selecciona un insumo --</option>
                            @foreach (var ins in todosInsumos)
                            {
                                <option value="@ins.IdInsumo"
                                        data-nombre="@ins.NombreInsumo"
                                        data-cantidad="@ins.CantidadDisponible.ToString(System.Globalization.CultureInfo.InvariantCulture)"
                                        data-stock="@ins.StockMinimo.ToString(System.Globalization.CultureInfo.InvariantCulture)"
                                        data-costo="@ins.CostoUnitario.ToString(System.Globalization.CultureInfo.InvariantCulture)"
                                        data-unidad="@ins.UnidadMedida"
                                        @@(insumo !=null && ins.IdInsumo= =insumo.IdInsumo ? "selected" : "" )>
                                    @ins.NombreInsumo — @ins.CantidadDisponible.ToString("N2") @ins.UnidadMedida
                                </option>
                            }
                        </select>
                        <small class="admin-form-hint">
                            <i class="fas fa-info-circle"></i>
                            Selecciona el insumo al que deseas registrarle un movimiento
                        </small>
                    </div>

                    <!-- Panel de info del insumo seleccionado (se llena/actualiza con JS) -->
                    <div id="panelInfoInsumo" style="display: @(insumo != null ? "block" : "none"); margin-bottom: 0.5rem;">
                        <div class="admin-form-info-box" style="background: linear-gradient(135deg, var(--olive-green) 0%, var(--dark-olive) 100%); border-color: transparent; color: white;">
                            <i class="fas fa-box" style="color: var(--cream); font-size: 1.5rem;"></i>
                            <div style="flex: 1;">
                                <strong id="infoNombre" style="color: var(--cream); font-size: 1.1rem;">
                                    @(insumo?.NombreInsumo ?? "")
                                </strong>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-top: 0.8rem;">
                                    <div>
                                        <span style="color: rgba(255,255,255,0.75); font-size: 0.85rem;">Cantidad disponible</span>
                                        <p id="infoCantidad" style="margin: 0; color: white; font-weight: 600;">
                                            @(insumo != null ? $"{insumo.CantidadDisponible:N2} {insumo.UnidadMedida}" : "")
                                        </p>
                                    </div>
                                    <div>
                                        <span style="color: rgba(255,255,255,0.75); font-size: 0.85rem;">Stock mínimo</span>
                                        <p id="infoStock" style="margin: 0; color: white; font-weight: 600;">
                                            @(insumo != null ? $"{insumo.StockMinimo:N2} {insumo.UnidadMedida}" : "")
                                        </p>
                                    </div>
                                    <div>
                                        <span style="color: rgba(255,255,255,0.75); font-size: 0.85rem;">Costo unitario</span>
                                        <p id="infoCosto" style="margin: 0; color: white; font-weight: 600;">
                                            @(insumo != null ? insumo.CostoUnitario.ToString("C2") : "")
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tipo de Movimiento -->
                    <div class="form-group">
                        <label>
                            <i class="fas fa-exchange-alt"></i>
                            Tipo de Movimiento
                        </label>
                        <div class="form-row">
                            <label class="feature-card"
                                   style="padding: 1.5rem; cursor: pointer; border: 3px solid var(--cream); margin: 0; transition: all 0.3s; flex: 1;"
                                   id="entradaLabel">
                                <input type="radio" name="TipoMovimiento" value="E"
                                       style="width: 20px; height: 20px; cursor: pointer; margin-bottom: 0.8rem;"
                                       @(!esSalida ? "checked" : "")>
                                <div style="text-align: center;">
                                    <div class="feature-icon" style="background: linear-gradient(135deg, var(--green), #229954); margin: 0 auto 0.8rem; width: 50px; height: 50px;">
                                        <i class="fas fa-arrow-down" style="color: white;"></i>
                                    </div>
                                    <strong style="color: var(--dark-green); font-size: 1.1rem; display: block; margin-bottom: 0.3rem;">Entrada</strong>
                                    <p style="margin: 0; color: var(--charcoal); opacity: 0.7; font-size: 0.85rem;">Agregar insumo al inventario</p>
                                </div>
                            </label>

                            <label class="feature-card"
                                   style="padding: 1.5rem; cursor: pointer; border: 3px solid var(--cream); margin: 0; transition: all 0.3s; flex: 1;"
                                   id="salidaLabel">
                                <input type="radio" name="TipoMovimiento" value="S"
                                       style="width: 20px; height: 20px; cursor: pointer; margin-bottom: 0.8rem;"
                                       @(esSalida ? "checked" : "")>
                                <div style="text-align: center;">
                                    <div class="feature-icon" style="background: linear-gradient(135deg, var(--red), #c0392b); margin: 0 auto 0.8rem; width: 50px; height: 50px;">
                                        <i class="fas fa-arrow-up" style="color: white;"></i>
                                    </div>
                                    <strong style="color: var(--dark-green); font-size: 1.1rem; display: block; margin-bottom: 0.3rem;">Salida</strong>
                                    <p style="margin: 0; color: var(--charcoal); opacity: 0.7; font-size: 0.85rem;">Retirar insumo del inventario</p>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Cantidad -->
                    <div class="form-group">
                        <label>
                            <i class="fas fa-boxes"></i>
                            Cantidad del Movimiento
                        </label>
                        @Html.TextBoxFor(model => model.Cantidad, new { @class = "form-control", type = "number", step = "0.01", min = "0.01", placeholder = "0.00", id = "cantidadMovimiento" })
                        @Html.ValidationMessageFor(model => model.Cantidad, "", new { @class = "text-danger" })

                        <!-- Alerta de stock insuficiente -->
                        <div id="alertaStockInsuficiente"
                             style="display: none; background: rgba(231, 76, 60, 0.1); border-left: 4px solid var(--red); padding: 1rem; border-radius: 10px; margin-top: 0.8rem;">
                            <p style="margin: 0; color: #c0392b; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-exclamation-triangle"></i>
                                <span>No se puede realizar la salida: stock insuficiente</span>
                            </p>
                        </div>

                        <!-- Vista previa de nueva cantidad -->
                        <div id="previsualizacion" class="admin-form-info-box" style="margin-top: 0.8rem;">
                            <i class="fas fa-calculator"></i>
                            <div style="display: flex; justify-content: space-between; align-items: center; flex: 1;">
                                <span>Nueva cantidad después del movimiento:</span>
                                <strong id="nuevaCantidad" style="color: var(--dark-green); font-size: 1.1rem;">—</strong>
                            </div>
                        </div>
                    </div>

                    <!-- Motivo -->
                    <div class="form-group">
                        <label>
                            <i class="fas fa-comment"></i>
                            Motivo del Movimiento
                        </label>
                        @Html.TextAreaFor(model => model.Motivo, new { @class = "form-control", rows = "4", placeholder = "Describe el motivo del movimiento..." })
                        @Html.ValidationMessageFor(model => model.Motivo, "", new { @class = "text-danger" })
                    </div>

                    <!-- Resumen del costo (solo para entradas) -->
                    <div id="resumenCosto" class="admin-form-info-box"
                         style="background: linear-gradient(135deg, var(--green) 0%, #229954 100%); border-color: transparent; color: white; display: @(esSalida ? "none" : "flex");">
                        <i class="fas fa-calculator" style="color: rgba(255,255,255,0.8);"></i>
                        <div style="flex: 1;">
                            <strong style="color: white;">Resumen del Costo</strong>
                            <div style="display: flex; justify-content: space-between; margin-top: 0.8rem; font-size: 0.95rem;">
                                <span style="color: rgba(255,255,255,0.85);">Costo unitario:</span>
                                <strong id="costoUnitarioResumen" style="color: white;">₡0.00</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-top: 0.4rem; font-size: 0.95rem;">
                                <span style="color: rgba(255,255,255,0.85);">Cantidad:</span>
                                <strong id="cantidadResumen" style="color: white;">0.00</strong>
                            </div>
                            <div style="border-top: 1px solid rgba(255,255,255,0.3); margin-top: 0.8rem; padding-top: 0.8rem; display: flex; justify-content: space-between; align-items: center;">
                                <span style="color: rgba(255,255,255,0.85); font-size: 1rem;">Costo total del movimiento:</span>
                                <strong id="costoTotal" style="font-size: 1.5rem; color: white;">₡0.00</strong>
                            </div>
                        </div>
                    </div>

                    <!-- Info box -->
                    <div class="admin-form-info-box">
                        <i class="fas fa-info-circle"></i>
                        <div>
                            <strong>Registro de Movimiento</strong>
                            <p>El movimiento quedará registrado en el historial y actualizará automáticamente el stock del insumo.</p>
                        </div>
                    </div>

                </div>

                <!-- Botones -->
                <div class="admin-form-footer">
                    <button type="button" class="btn btn-secondary" onclick="history.back()">
                        <i class="fas fa-times"></i>
                        <span>Cancelar</span>
                    </button>
                    <button type="submit" id="btnRegistrar" class="btn btn-primary">
                        <i class="fas fa-save"></i>
                        <span>Registrar Movimiento</span>
                    </button>
                </div>
            </div>
        }
    </div>
</section>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        // Variables globales que usa movimiento.js — se actualizan cuando cambia el combobox
        let cantidadActual = @(insumo != null ? insumo.CantidadDisponible.ToString(System.Globalization.CultureInfo.InvariantCulture) : "0");
        let costoUnitario  = @(insumo != null ? insumo.CostoUnitario.ToString(System.Globalization.CultureInfo.InvariantCulture) : "0");
        let unidad         = "@Html.Raw(insumo?.UnidadMedida ?? "")";

        document.getElementById('selectorInsumo').addEventListener('change', function () {
            const opt = this.options[this.selectedIndex];
            const panel = document.getElementById('panelInfoInsumo');

            if (!this.value) {
                panel.style.display = 'none';
                cantidadActual = 0;
                costoUnitario  = 0;
                unidad         = '';
                document.getElementById('hiddenIdInsumo').value = '';
                document.getElementById('nuevaCantidad').textContent = '—';
                document.getElementById('costoUnitarioResumen').textContent = '₡0.00';
                return;
            }

            // Leer data-attributes de la opción seleccionada
            cantidadActual = parseFloat(opt.dataset.cantidad) || 0;
            costoUnitario  = parseFloat(opt.dataset.costo)    || 0;
            unidad         = opt.dataset.unidad || '';

            // Actualizar hidden field
            document.getElementById('hiddenIdInsumo').value = this.value;

            // Actualizar panel visual
            document.getElementById('infoNombre').textContent   = opt.dataset.nombre;
            document.getElementById('infoCantidad').textContent = cantidadActual.toFixed(2) + ' ' + unidad;
            document.getElementById('infoStock').textContent    = parseFloat(opt.dataset.stock).toFixed(2) + ' ' + unidad;
            document.getElementById('infoCosto').textContent    = '₡' + costoUnitario.toLocaleString('es-CR', { minimumFractionDigits: 2 });
            document.getElementById('costoUnitarioResumen').textContent = '₡' + costoUnitario.toLocaleString('es-CR', { minimumFractionDigits: 2 });

            panel.style.display = 'block';

            // Recalcular nueva cantidad si ya hay algo en el input
            const inputCantidad = document.getElementById('cantidadMovimiento');
            if (inputCantidad) inputCantidad.dispatchEvent(new Event('input'));
        });

        // Si ya viene un insumo preseleccionado, mostrar su costo unitario en el resumen
        (function () {
            const sel = document.getElementById('selectorInsumo');
            if (sel && sel.value) {
                const opt = sel.options[sel.selectedIndex];
                const cu = parseFloat(opt.dataset.costo) || 0;
                document.getElementById('costoUnitarioResumen').textContent =
                    '₡' + cu.toLocaleString('es-CR', { minimumFractionDigits: 2 });
            }
        })();
    </script>
    <script src="~/js/movimiento.js"></script>
}